let mediaRecorder,chunks=[],isRecording=false;const els={input:document.getElementById('inputText'),output:document.getElementById('outputText'),btnMic:document.getElementById('btnMic'),btnStop:document.getElementById('btnStop'),btnTranslate:document.getElementById('btnTranslate'),btnSpeak:document.getElementById('btnSpeak'),asrState:document.getElementById('asrState'),mtState:document.getElementById('mtState'),ttsState:document.getElementById('ttsState'),audio:document.getElementById('audio'),asrURL:document.getElementById('asrURL'),mtURL:document.getElementById('mtURL'),ttsURL:document.getElementById('ttsURL'),sourceLang:document.getElementById('sourceLang'),targetLang:document.getElementById('targetLang')};function setBadge(e,t){e.textContent=t?'已连接':'未连接',e.className='pill '+(t?'ok':'')}function check(){setBadge(els.asrState,!!els.asrURL.value),setBadge(els.mtState,!!els.mtURL.value),setBadge(els.ttsState,!!els.ttsURL.value)}['asrURL','mtURL','ttsURL'].forEach(e=>els[e].addEventListener('input',check)),check();async function postASR(e){if(!els.asrURL.value)return void alert('未配置 ASR API');const t=new FormData;t.append('file',e,'audio.webm');const a=await fetch(els.asrURL.value,{method:'POST',body:t});if(!a.ok)throw new Error('ASR 失败');const n=await a.json();return n.text||''}async function postMT(e){if(!els.mtURL.value)return e.replace(/你们/g,'你哋').replace(/我们/g,'我哋').replace(/不要|别/g,'唔好');const t=await fetch(els.mtURL.value,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:e,source_lang:els.sourceLang.value,target_lang:els.targetLang.value})});if(!t.ok)throw new Error('MT 失败');const a=await t.json();return a.text||''}async function postTTS(e){if(!els.ttsURL.value){if('speechSynthesis'in window){const t=new SpeechSynthesisUtterance(e);t.lang='zh-HK',speechSynthesis.speak(t)}return}const t=await fetch(els.ttsURL.value,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:e,lang:'yue_Hant'})});if(!t.ok)throw new Error('TTS 失败');const a=await t.arrayBuffer(),n=new Blob([a],{type:'audio/mpeg'});els.audio.src=URL.createObjectURL(n),els.audio.play()}async function startRec(){const e=await navigator.mediaDevices.getUserMedia({audio:!0});chunks=[],(mediaRecorder=new MediaRecorder(e)).ondataavailable=t=>chunks.push(t.data),mediaRecorder.onstop=async()=>{const e=new Blob(chunks,{type:'audio/webm'});try{els.input.value=await postASR(e)}catch(e){alert(e.message)}};mediaRecorder.start(),isRecording=!0,els.btnMic.disabled=!0,els.btnStop.disabled=!1}function stopRec(){mediaRecorder&&isRecording&&(mediaRecorder.stop(),isRecording=!1,els.btnMic.disabled=!1,els.btnStop.disabled=!0)}els.btnMic.onclick=startRec,els.btnStop.onclick=stopRec,els.btnTranslate.onclick=async()=>{const e=els.input.value.trim();if(!e)return alert('请先输入文本');try{els.output.value=await postMT(e)}catch(e){alert(e.message)}};els.btnSpeak.onclick=()=>{const e=els.output.value.trim()||els.input.value.trim();if(!e)return alert('没有可播报文本');postTTS(e)};