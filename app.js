let mediaRecorder,chunks=[],isRecording=false;const I=e=>document.getElementById(e),els={input:I('inputText'),output:I('outputText'),btnMic:I('btnMic'),btnStop:I('btnStop'),btnTranslate:I('btnTranslate'),btnSpeak:I('btnSpeak'),audio:I('audio')};async function postASR(b){const f=new FormData;f.append('file',b,'audio.webm');const r=await fetch('/api/asr',{method:'POST',body:f});if(!r.ok)throw new Error('ASR失败');return (await r.json()).text||''}async function postMT(t){const r=await fetch('/api/translate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t,source_lang:'auto',target_lang:'yue_Hant'})});if(!r.ok)throw new Error('MT失败');return (await r.json()).text||''}async function postTTS(t){const r=await fetch('/api/tts',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:t,lang:'yue_Hant'})});if(!r.ok)throw new Error('TTS失败');const a=await r.arrayBuffer();const blob=new Blob([a],{type:'audio/mpeg'});els.audio.src=URL.createObjectURL(blob);els.audio.play()}async function startRec(){const s=await navigator.mediaDevices.getUserMedia({audio:true});chunks=[];const rec=new MediaRecorder(s);mediaRecorder=rec;rec.ondataavailable=e=>chunks.push(e.data);rec.onstop=async()=>{const blob=new Blob(chunks,{type:'audio/webm'});try{els.input.value=await postASR(blob)}catch(e){alert(e.message)}};rec.start();isRecording=true;els.btnMic.disabled=true;els.btnStop.disabled=false}function stopRec(){if(mediaRecorder&&isRecording){mediaRecorder.stop();isRecording=false;els.btnMic.disabled=false;els.btnStop.disabled=true}}els.btnMic.onclick=startRec;els.btnStop.onclick=stopRec;els.btnTranslate.onclick=async()=>{const t=els.input.value.trim();if(!t)return alert('请先输入');try{els.output.value=await postMT(t)}catch(e){alert(e.message)}};els.btnSpeak.onclick=async()=>{const t=(els.output.value.trim()||els.input.value.trim());if(!t)return alert('没有可播文');try{await postTTS(t)}catch(e){alert(e.message)}};