<!doctype html>
<html lang="zh-HK"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Funwa-1101CanTongMVP · v3</title>
<style>
:root{--bg:#0b0f14;--panel:#0f1720;--muted:#94a3b8;--border:#1f2937}
html,body{margin:0;background:var(--bg);color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'PingFang SC','Noto Sans SC',sans-serif}
.wrap{max-width:1100px;margin:28px auto;padding:0 14px}
.panel{background:#0f1720;border-radius:14px;padding:18px;border:1px solid var(--border)}
.row{display:flex;gap:10px}
h1{margin:0 0 10px;font-size:22px}
input{flex:1;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:12px 14px;font-size:16px}
button{background:#0ea5e9;border:0;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
.hint{color:var(--muted);font-size:13px;margin-top:8px}
.suggest a{display:inline-block;color:#93c5fd;margin:8px 10px 0 0;text-decoration:none;border:1px solid #334155;border-radius:999px;padding:6px 10px}
.grid{display:grid;grid-template-columns:1.3fr 1fr;gap:12px;margin-top:16px}
.box{border-radius:12px;padding:12px;border:1px solid #1f2937}
.box h3{margin:0 0 6px;font-size:13px;color:#94a3b8}
.y{background:#1b2105;border-color:#3a3f1b}.b{background:#0b1528;border-color:#1f3352}.r{background:#2b0f12;border-color:#4a1e23}.w{background:#141922;border-color:#2c3440}.g{background:#0f131a;border-color:#1f2937}
.pill{display:inline-flex;align-items:center;background:#1f2937;border:1px solid #374151;border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
.play{margin-left:8px;color:#93c5fd;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:6px}
th,td{border-bottom:1px solid #1f2937;padding:10px 8px;font-size:14px;vertical-align:top}
th{color:#94a3b8;font-weight:600}
.footer{color:#94a3b8;font-size:12px;margin-top:14px}
</style></head>
<body>
<div class="wrap panel">
  <h1>Funwa-1101CanTongMVP <span style="font-size:12px;border:1px solid #374151;border-radius:999px;padding:2px 8px;background:#1f2937">v3 CSV</span></h1>
  <div class="row">
    <input id="q" placeholder="输入 中文 / English / 粤语（皆可检索）…">
    <button id="go">查询</button>
    <button id="say" style="background:#374151">朗读</button>
  </div>
  <div class="hint">支持按备注、例句、别名搜索；输入一两个字母也会联想（来自 <code>data/crossmap.csv</code>）。</div>
  <div id="sg" class="suggest"></div>
  <div class="grid">
    <div class="box y"><h3>粤语 (zhh)</h3><div id="zhh"></div></div>
    <div class="box b"><h3>英文 (en)</h3><div id="en"></div></div>
    <div class="box r"><h3>同义 / 相关</h3><div id="alias"></div></div>
    <div class="box w"><h3>备注 / Notes</h3><div id="notes"></div></div>
  </div>
  <div class="box" style="margin-top:12px;background:#141418;border-color:#2c2c30"><h3>中文 (chs)</h3><div id="chs"></div></div>
  <div class="box g" style="margin-top:12px"><h3>example</h3><table><thead><tr><th>粵語</th><th>中文</th><th>英文</th></tr></thead><tbody id="ex"></tbody></table></div>
  <div class="footer">© Funwa-1101CanTongMVP — Code MIT, Lexicon Closed; data/*.csv CC BY-NC-ND.</div>
</div>
<script>
function parseCSV(t){const rows=[],cur=[];let f='',i=0,q=false;while(i<t.length){const c=t[i];if(q){if(c=='"'){if(t[i+1]=='"'){f+='"';i+=2;continue;}q=false;i++;continue;}else{f+=c;i++;continue;}}else{if(c=='"'){q=true;i++;continue;}if(c==','){cur.push(f);f='';i++;continue;}if(c=='
'){cur.push(f);rows.push(cur.slice());cur.length=0;f='';i++;continue;}if(c==''){i++;continue;}f+=c;i++;continue;}}if(f.length||cur.length){cur.push(f);rows.push(cur);}const head=(rows.shift()||[]).map(s=>s.trim());return rows.filter(r=>r.length&&r.some(x=>String(x).trim()!=='')).map(r=>{const o={};head.forEach((k,j)=>o[k]=(r[j]??'').trim());return o;});}
async function loadCSV(p){const r=await fetch(p+'?v='+Date.now(),{cache:'no-store'});if(!r.ok)throw new Error(p);return parseCSV(await r.text());}
const S={lex:new Map(),ex:new Map(),idx:new Map()};
function seg(s){return(s||'').split('/').map(x=>x.trim()).filter(Boolean);}
function idxPut(k,v){k=(k||'').toLowerCase().trim();if(!k)return;if(!S.idx.has(k))S.idx.set(k,[]);S.idx.get(k).push(v);}
function chip(t,play){const e=document.createElement('span');e.className='pill';e.textContent=t;if(play){const p=document.createElement('span');p.className='play';p.textContent='▶';p.onclick=play;e.appendChild(p);}return e;}
function tts(t){try{const u=new SpeechSynthesisUtterance(t);u.lang='zh-HK';speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){}}
async function boot(){const[lx,ex,mp]=await Promise.all([loadCSV('/data/lexeme.csv'),loadCSV('/data/examples.csv'),loadCSV('/data/crossmap.csv')]);for(const r of lx){const id=r.id||r.ID||r.Id;if(!id)continue;S.lex.set(id,{id,zhh:r.zhh||r.cantonese||'',chs:r.chs||r.zh||r.cn||'',en:r.en||r.eng||'',notes:r.notes||r.note||''});}for(const r of ex){const lid=r.lexeme_id||r.lex_id||r.id||r.ID;if(!lid)continue;if(!S.ex.has(lid))S.ex.set(lid,[]);S.ex.get(lid).push({zhh:r.zhh||'',chs:r.chs||'',en:r.en||''});}for(const r of mp){const tid=r.target_id||r.lexeme_id||r.id||r.ID;const term=r.term||r.key||r.word;if(term&&tid)idxPut(term,{id:tid,kind:r.kind||'head'});}for(const r of S.lex.values()){[...seg(r.zhh),...seg(r.chs),...seg(r.en)].forEach(k=>idxPut(k,{id:r.id,kind:'head'}));(r.notes||'').split(/[\s,，。；;、/]+/).forEach(t=>idxPut(t,{id:r.id,kind:'note'}));(S.ex.get(r.id)||[]).forEach(e=>{[e.zhh,e.chs,e.en].forEach(x=>(x||'').split(/[\s,，。；;、/]+/).forEach(t=>idxPut(t,{id:r.id,kind:'example'})));});}bind();}
function bind(){const q=document.getElementById('q');document.getElementById('go').onclick=()=>search(q.value);document.getElementById('say').onclick=()=>tts(q.value||'掟嘢');q.onkeydown=e=>{if(e.key==='Enter')search(q.value)};q.oninput=()=>suggest(q.value);}
function suggest(v){const d=document.getElementById('sg');d.innerHTML='';const q=(v||'').trim().toLowerCase();if(!q)return;Array.from(S.idx.keys()).filter(k=>k.startsWith(q)).slice(0,10).forEach(k=>{const a=document.createElement('a');a.textContent=k;a.href='javascript:void(0)';a.onclick=()=>{document.getElementById('q').value=k;search(k)};d.appendChild(a);});}
function search(v){const q=(v||'').trim().toLowerCase();let c=S.idx.get(q);if(!c){const first=Array.from(S.idx.keys()).find(k=>k.startsWith(q));if(first)c=S.idx.get(first);}if(!c){renderNone();return;}render(c[0].id,q);}
function renderNone(){['zhh','chs','en','notes','alias'].forEach(id=>document.getElementById(id).textContent='');document.getElementById('ex').innerHTML='';}
function render(id,q){const r=S.lex.get(id);if(!r){renderNone();return;}const z=document.getElementById('zhh');z.innerHTML='';seg(r.zhh).forEach(s=>z.appendChild(chip(s,()=>tts(s))));const c=document.getElementById('chs');c.innerHTML='';seg(r.chs).forEach(s=>c.appendChild(chip(s)));const e=document.getElementById('en');e.innerHTML='';seg(r.en).forEach(s=>e.appendChild(chip(s)));document.getElementById('notes').textContent=r.notes||'—';const a=document.getElementById('alias');a.innerHTML='';const set=new Set([...seg(r.chs),...seg(r.zhh),...seg(r.en)]);set.forEach(s=>{if((s||'').toLowerCase()!=q){const sp=document.createElement('span');sp.className='pill';sp.textContent=s;a.appendChild(sp);}});const tb=document.getElementById('ex');tb.innerHTML='';(S.ex.get(r.id)||[]).forEach(row=>{const tr=document.createElement('tr');['zhh','chs','en'].forEach(k=>{const td=document.createElement('td');td.textContent=row[k]||'';tr.appendChild(td)});tb.appendChild(tr);});}
boot().catch(err=>{console.error(err);alert('加载 CSV 失败：'+err.message)});
</script>
</body></html>
