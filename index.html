<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funwa</title>
  <style>
    :root{
      --bg:#03060a; --muted:#9aa5b1; --ink:#fafcff; --input:#10141c;
      --pink:#ff0684; --lime:#a5ff00; --chip:#0f1720; --shadow:rgba(0,0,0,.45);
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue","PingFang SC","Noto Sans SC","Hiragino Sans GB",sans-serif}
    .wrap{max-width:980px;margin:8vh auto 10vh;padding:0 16px}
    .hero{display:flex;flex-direction:column;gap:14px;align-items:stretch}
    .brand{font-weight:800;letter-spacing:.5px;font-size:22px;opacity:.9}
    .search{display:flex;gap:10px;align-items:center;position:relative}
    .i{flex:1;background:var(--input);color:var(--ink);border:none;border-radius:14px;padding:14px 16px;font-size:18px;outline:none;box-shadow:0 10px 26px var(--shadow)}
    .btn{background:var(--pink);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .hint{font-size:12px;color:var(--muted)}
    .drop{position:absolute;left:0;right:120px;top:52px;background:var(--input);border-radius:12px;box-shadow:0 18px 28px var(--shadow);overflow:hidden;z-index:10}
    .opt{padding:10px 14px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,.05)}
    .results{display:none;margin-top:22px;animation:fade .25s ease-out forwards}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .blk{border-radius:18px;padding:14px 16px;box-shadow:0 14px 28px var(--shadow);margin-top:12px}
    .pink{background:color-mix(in srgb, var(--pink) 24%, transparent)}
    .lime{background:color-mix(in srgb, var(--lime) 20%, transparent)}
    .gray{background:color-mix(in srgb, #ffffff 8%, transparent)}
    .cap{font-size:12px;letter-spacing:.12em;text-transform:uppercase;opacity:.8;margin:4px 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:color-mix(in srgb, var(--pink) 32%, transparent);padding:10px 14px;border-radius:999px;margin:8px 10px 0 0}
    .chip{display:inline-block;background:var(--chip);padding:8px 12px;border-radius:999px;margin:8px 8px 0 0;color:#dbe3ea}
    .tag{display:inline-block;background:rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;margin-left:8px;font-size:12px}
    .play{cursor:pointer;font-size:12px;opacity:.95}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left}
    thead th{opacity:.8}
    .src{font-size:12px;opacity:.8;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">Funwa</div>
      <div class="search">
        <input id="q" class="i" type="search" placeholder="Type Chinese / English / Cantonese…" autocomplete="off" />
        <button id="btn" class="btn">Search</button>
        <div id="drop" class="drop" style="display:none"></div>
      </div>
      <div class="hint">Type to see live suggestions (internal CSV + open-source seed). Your CSV overrides seed.</div>
    </div>

    <div id="res" class="results">
      <div class="blk pink">
        <div class="cap">CANTONESE · zhh <span id="badge" class="tag" style="display:none">open</span></div>
        <div id="zhh"></div>
      </div>

      <div id="aliases_blk" class="blk pink" style="display:none">
        <div class="cap">ALIASES · zhh</div>
        <div id="zhh_alias"></div>
      </div>

      <div class="blk gray">
        <div class="cap">ENGLISH · en</div>
        <div id="en"></div>
      </div>

      <div class="blk lime">
        <div class="cap">NOTES</div>
        <div id="notes"></div>
      </div>

      <div id="ex_blk" class="blk pink" style="display:none">
        <div class="cap">EXAMPLES</div>
        <table>
          <thead><tr><th>Cantonese</th><th>Chinese</th><th>English</th><th>Variant</th></tr></thead>
          <tbody id="exbody"></tbody>
        </table>
        <div id="src" class="src"></div>
      </div>
    </div>
  </div>

<script>
function stripBOM(s){ return s.replace(/^\uFEFF/,''); }
function parseCSV(text){
  text = stripBOM(text).replace(/\r\n/g,"\n").replace(/\r/g,"\n");
  const rows=[]; let row=[], field='', inQ=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i], next=text[i+1];
    if(ch==='"'){
      if(inQ && next==='"'){ field+='"'; i++; }
      else inQ=!inQ;
    } else if(ch===',' && !inQ){ row.push(field); field=''; }
    else if(ch==='\n' && !inQ){ row.push(field); rows.push(row); row=[]; field=''; }
    else { field+=ch; }
  }
  if(field.length||row.length){ row.push(field); rows.push(row); }
  if(!rows.length) return [];
  const H=rows[0].map(s=>s.trim());
  return rows.slice(1).filter(r=>r.some(x=>x!=='')).map(r=>{
    const o={}; H.forEach((h,i)=> o[h]= (r[i]||'').trim()); return o;
  });
}
async function loadCSV(path){
  const r = await fetch(path+'?v='+Date.now(), {cache:'no-store'});
  if(!r.ok) return [];
  return parseCSV(await r.text());
}
const S={lex:new Map(), ex:new Map(), idx:new Map(), open:new Map(), xmap:[]};
const split=s=>(s||'').split('/').map(x=>x.trim()).filter(Boolean);
const put=(k,v)=>{k=(k||'').toLowerCase(); if(!k) return; if(!S.idx.has(k)) S.idx.set(k,[]); S.idx.get(k).push(v);};

async function boot(){
  const [lex, ex, seed, xmap] = await Promise.all([
    loadCSV('data/lexeme.csv'),
    loadCSV('data/examples.csv'),
    loadCSV('data/external_seed.csv'),
    loadCSV('data/crossmap.csv')
  ]);
  lex.forEach(r=>{ if(r.id) S.lex.set(r.id,{...r,source:'internal'}); });
  ex.forEach(r=>{ if(r.lexeme_id){ if(!S.ex.has(r.lexeme_id)) S.ex.set(r.lexeme_id,[]); S.ex.get(r.lexeme_id).push(r);} });
  seed.forEach(r=>{ if(r.id){ S.open.set(r.id,r); }});
  S.xmap = xmap;

  for(const [id,r] of S.lex.entries()){
    [...split(r.zhh),...split(r.alias_zhh),...split(r.en)].forEach(t=> put(t,{id,kind:'head',who:'internal'}));
    (r.note_en||'').split(/[,;，；、\s]+/).forEach(t=> put(t,{id,kind:'note',who:'internal'}));
    (r.note_chs||'').split(/[,;，；、\s]+/).forEach(t=> put(t,{id,kind:'note',who:'internal'}));
  }
  for(const [id,r] of S.open.entries()){
    [...split(r.zhh),...split(r.en)].forEach(t=> put(t,{id,kind:'head',who:'open'}));
  }
  for(const r of S.xmap){
    if(r.term && r.target_id){
      put(r.term, {id:r.target_id, kind:r.kind||'map', who:'internal'});
    }
  }
  wire();
}

function wire(){
  const q = document.getElementById('q');
  const btn = document.getElementById('btn');
  const drop = document.getElementById('drop');
  function showSuggest(v){
    const s=(v||'').trim().toLowerCase();
    if(!s){ drop.style.display='none'; drop.innerHTML=''; return; }
    const keys=[...S.idx.keys()];
    const seen=new Set(); const hit=[];
    for(const k of keys){
      if(k.startsWith(s) && !seen.has(k)){ hit.push(k); seen.add(k); if(hit.length>=8) break; }
    }
    if(!hit.length){ drop.style.display='none'; drop.innerHTML=''; return; }
    drop.style.display='block'; drop.innerHTML='';
    hit.forEach(k=>{
      const d=document.createElement('div'); d.className='opt'; d.textContent=k;
      d.onclick=()=>{ q.value=k; drop.style.display='none'; openBest(k); };
      drop.appendChild(d);
    });
  }
  function openBest(text){
    const s=(text||'').trim().toLowerCase(); if(!s) return;
    let cand = S.idx.get(s);
    if(!cand){ const key=[...S.idx.keys()].find(k=>k.startsWith(s)); if(key) cand=S.idx.get(key); }
    if(!cand) return;
    const inx=cand.find(x=>x.who==='internal')||cand[0];
    render(inx.id, inx.who);
  }
  q.addEventListener('input', e=> showSuggest(e.target.value));
  q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ openBest(q.value); drop.style.display='none'; } });
  btn.addEventListener('click', ()=>{ openBest(q.value); drop.style.display='none'; });
}

function render(id, who){
  const box=document.getElementById('res');
  const badge=document.getElementById('badge');
  let r = (who==='internal') ? S.lex.get(id) : S.open.get(id);
  if(!r){ box.style.display='none'; return; }
  box.style.display='block';
  badge.style.display = (who==='open') ? 'inline-block' : 'none';

  const z=document.getElementById('zhh'); z.innerHTML='';
  const seg=(r.zhh||'').split('/').filter(Boolean), prn=(r.zhh_pron||'').split('/');
  seg.forEach((s,i)=>{
    const el=document.createElement('span'); el.className='pill'; el.textContent=s;
    const p=document.createElement('span'); p.className='play'; p.textContent='▶'; p.title=prn[i]||'';
    p.onclick=()=> speakHK(s);
    el.appendChild(p); z.appendChild(el);
  });

  const ablk=document.getElementById('aliases_blk'); const az=document.getElementById('zhh_alias'); az.innerHTML='';
  if(r.alias_zhh && who==='internal'){ const alias=(r.alias_zhh||'').split('/').filter(Boolean); if(alias.length){ ablk.style.display='block'; alias.forEach(s=>{ const el=document.createElement('span'); el.className='pill'; el.textContent=s; az.appendChild(el); }); } else{ ablk.style.display='none'; } }
  else{ ablk.style.display='none'; }

  const e=document.getElementById('en'); e.innerHTML='';
  (r.en||'').split('/').filter(Boolean).forEach(s=>{ const c=document.createElement('span'); c.className='chip'; c.textContent=s; e.appendChild(c); });

  const nt=document.getElementById('notes');
  const note_en=r.note_en||''; const note_chs=r.note_chs||'';
  nt.innerHTML=[note_en,note_chs].filter(Boolean).map(x=>`<div style="margin:4px 0">${x}</div>`).join('') || '<div style="opacity:.45">—</div>';

  const arr=S.ex.get(id)||[];
  const exblk=document.getElementById('ex_blk'); const tbody=document.getElementById('exbody'); tbody.innerHTML='';
  if(arr.length){ exblk.style.display='block'; } else { exblk.style.display='none'; }
  arr.forEach(ex=>{
    const tr=document.createElement('tr');
    const td0=document.createElement('td'); td0.innerHTML=`<span class="pill">${(ex.ex_zhh||'')}</span> <span class="play" title="${ex.ex_zhh_pron||''}">▶</span>`;
    td0.querySelector('.play').onclick=()=> speakHK(ex.ex_zhh||'');
    const td1=document.createElement('td'); td1.textContent=ex.ex_chs||'';
    const td2=document.createElement('td'); td2.textContent=ex.ex_en||'';
    const td3=document.createElement('td'); td3.textContent=ex.ex_variant||'';
    tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tbody.appendChild(tr);
  });
  const src=document.getElementById('src');
  src.innerHTML = (who==='open' && (r.source||r.license)) ? `Source: ${r.source||''} · ${r.license||''}` : '';
}

function speakHK(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='zh-HK'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

boot();
</script>
</body>
</html>
