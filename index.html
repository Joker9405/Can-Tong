<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funwa</title>
  <style>
    :root{
      --bg:#03060a; --muted:#9aa5b1; --ink:#fafcff; --input:#10141c;
      --pink:#ff0684; --lime:#a5ff00; --chip:#0f1720; --shadow:rgba(0,0,0,.45);
    }
    html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue","PingFang SC","Noto Sans SC","Hiragino Sans GB",sans-serif}
    .wrap{max-width:980px;margin:8vh auto 10vh;padding:0 16px}
    .hero{display:flex;flex-direction:column;gap:14px;align-items:stretch}
    .brand{font-weight:800;letter-spacing:.5px;font-size:22px;opacity:.9}
    .search{display:flex;gap:10px;align-items:center;position:relative}
    .i{flex:1;background:var(--input);color:var(--ink);border:none;border-radius:14px;padding:14px 16px;font-size:18px;outline:none;box-shadow:0 10px 26px var(--shadow)}
    .btn{background:var(--pink);color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .hint{font-size:12px;color:var(--muted)}
    .drop{position:absolute;left:0;right:120px;top:52px;background:var(--input);border-radius:12px;box-shadow:0 18px 28px var(--shadow);overflow:hidden;z-index:10}
    .opt{padding:10px 14px;cursor:pointer}
    .opt:hover{background:rgba(255,255,255,.05)}
    .results{display:none;margin-top:22px;animation:fade .25s ease-out forwards}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
    .blk{border-radius:18px;padding:14px 16px;box-shadow:0 14px 28px var(--shadow);margin-top:12px}
    .pink{background:color-mix(in srgb, var(--pink) 24%, transparent)}
    .lime{background:color-mix(in srgb, var(--lime) 20%, transparent)}
    .gray{background:color-mix(in srgb, #ffffff 8%, transparent)}
    .cap{font-size:12px;letter-spacing:.12em;text-transform:uppercase;opacity:.8;margin:4px 0 8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:color-mix(in srgb, var(--pink) 32%, transparent);padding:10px 14px;border-radius:999px;margin:8px 10px 0 0}
    .chip{display:inline-block;background:var(--chip);padding:8px 12px;border-radius:999px;margin:8px 8px 0 0;color:#dbe3ea}
    .tag{display:inline-block;background:rgba(255,255,255,.08);padding:2px 8px;border-radius:999px;margin-left:8px;font-size:12px}
    .play{cursor:pointer;font-size:12px;opacity:.95}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left}
    thead th{opacity:.8}
    .src{font-size:12px;opacity:.8;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <div class="brand">Funwa</div>
      <div class="search">
        <input id="q" class="i" type="search" placeholder="Type Chinese / English / Cantonese…" autocomplete="off" />
        <button id="btn" class="btn">Search</button>
        <div id="drop" class="drop" style="display:none"></div>
      </div>
      <div class="hint">Type to see live suggestions (internal CSV + open-source seed). Your CSV overrides seed.</div>
    </div>

    <div id="res" class="results">
      <div class="blk pink">
        <div class="cap">CANTONESE · zhh <span id="badge" class="tag" style="display:none">open</span></div>
        <div id="zhh"></div>
      </div>

      <div id="aliases_blk" class="blk pink" style="display:none">
        <div class="cap">ALIASES · zhh</div>
        <div id="zhh_alias"></div>
      </div>

      <div class="blk gray">
        <div class="cap">ENGLISH · en</div>
        <div id="en"></div>
      </div>

      <div class="blk lime">
        <div class="cap">NOTES</div>
        <div id="notes"></div>
      </div>

      <div id="ex_blk" class="blk pink" style="display:none">
        <div class="cap">EXAMPLES</div>
        <table>
          <thead><tr><th>Cantonese</th><th>Chinese</th><th>English</th><th>Variant</th></tr></thead>
          <tbody id="exbody"></tbody>
        </table>
        <div id="src" class="src"></div>
      </div>
    </div>
  </div>

<script>
function stripBOM(s){ return s.replace(/^\uFEFF/,''); }
function parseCSV(text){
  text = stripBOM(text);
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(x=>x.length);
  const H = lines[0].split(",").map(s=>stripBOM(s).trim());
  return lines.slice(1).map(line=>{
    const C = line.split(",");
    const o={}; H.forEach((h,i)=> o[h]= stripBOM((C[i]||"").trim())); return o;
  });
}
async function loadCSV(path){
  const r = await fetch(path+'?v='+Date.now(), {cache:'no-store'});
  if(!r.ok) return [];
  return parseCSV(await r.text());
}
const S={lex:new Map(), ex:new Map(), idx:new Map(), open:new Map()};
const split=s=>(s||'').split('/').map(x=>x.trim()).filter(Boolean);
const put=(k,v)=>{k=(k||'').toLowerCase(); if(!k) return; if(!S.idx.has(k)) S.idx.set(k,[]); S.idx.get(k).push(v);};

async function boot(){
  const [lex, ex, seed] = await Promise.all([
    loadCSV('data/lexeme.csv'),
    loadCSV('data/examples.csv'),
    loadCSV('data/external_seed.csv') // optional
  ]);
  lex.forEach(r=>{ if(r.id) S.lex.set(r.id,{...r,source:'internal'}); });
  ex.forEach(r=>{ if(r.lexeme_id){ if(!S.ex.has(r.lexeme_id)) S.ex.set(r.lexeme_id,[]); S.ex.get(r.lexeme_id).push(r);} });
  seed.forEach(r=>{ if(r.id){ S.open.set(r.id,r); }});

  // build index: internal first (override), then open seed
  for(const [id,r] of S.lex.entries()){
    [...split(r.zhh),...split(r.alias_zhh),...split(r.en)].forEach(t=> put(t,{id,kind:'head',who:'internal'}));
    (r.note_en||'').split(/[,;，；、\s]+/).forEach(t=> put(t,{id,kind:'note',who:'internal'}));
    (r.note_chs||'').split(/[,;，；、\s]+/).forEach(t=> put(t,{id,kind:'note',who:'internal'}));
  }
  for(const [id,r] of S.open.entries()){
    [...split(r.zhh),...split(r.en)].forEach(t=> put(t,{id,kind:'head',who:'open'}));
  }

  wire();
}

function wire(){
  const q = document.getElementById('q');
  const btn = document.getElementById('btn');
  const drop = document.getElementById('drop');

  function showSuggest(v){
    const s=(v||'').trim().toLowerCase();
    if(!s){ drop.style.display='none'; drop.innerHTML=''; return; }
    const keys=[...S.idx.keys()];
    const seen=new Set();
    const hit=[];
    for(const k of keys){
      if(k.startsWith(s) && !seen.has(k)){ hit.push(k); if(hit.length>=8) break; }
    }
  }
</script>
</body>
</html>
