<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Funwa · Slim V3</title>
<style>
:root{
  --bg:#070b11; --white:#e6edf3; --gray:#1e293b; --border:#2b3240;
  --pink:#ff63b2; --lime:#b9ff38; --muted:#94a3b8;
}
body{background:var(--bg);color:var(--white);font-family:'Inter','PingFang SC','Noto Sans SC',sans-serif;margin:0;padding:0;}
.container{max-width:800px;margin:100px auto;padding:0 20px;text-align:center;}
input[type='search']{
  width:100%;padding:14px 16px;font-size:18px;border-radius:12px;
  border:1px solid var(--border);background:#10141c;color:var(--white);
  outline:none;transition:all .2s;
}
input[type='search']:focus{border-color:var(--pink);}
.suggest{color:var(--muted);font-size:14px;text-align:left;margin-top:6px;}
.result{margin-top:40px;display:none;animation:fadeIn .3s ease forwards;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.section{margin-top:20px;text-align:left;}
.cap{font-size:12px;letter-spacing:.1em;color:var(--muted);margin-bottom:6px;}
.blk{padding:14px;border-radius:16px;border:1px solid var(--border);}
.pink{background:rgba(255,99,178,0.1);}
.lime{background:rgba(185,255,56,0.1);}
.gray{background:#0b1119;}
.pill{display:inline-flex;align-items:center;padding:8px 12px;margin:4px;border-radius:999px;background:rgba(255,99,178,0.2);}
.pill span.play{margin-left:8px;cursor:pointer;color:var(--pink);}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:10px;border-bottom:1px solid var(--border);font-size:14px;}
th{color:var(--muted);text-align:left;}
tr td:first-child{color:var(--pink);}
tr td:last-child{color:var(--white);}
footer{margin-top:40px;font-size:12px;color:var(--muted);}
</style>
</head>
<body>
<div class="container">
  <h1 style="font-size:22px;margin-bottom:20px;">Funwa · Slim V3</h1>
  <input id="q" type="search" placeholder="Type to search Cantonese / English..." autocomplete="off"/>
  <div id="suggest" class="suggest"></div>
  <div id="result" class="result">
    <div class="section"><div class="cap">CANTONESE</div><div id="zhh" class="blk pink"></div></div>
    <div class="section"><div class="cap">ENGLISH</div><div id="en" class="blk gray"></div></div>
    <div class="section"><div class="cap">NOTES</div><div id="notes" class="blk lime"></div></div>
    <div class="section"><div class="cap">EXAMPLES</div><div class="blk pink"><table><thead><tr><th>Cantonese</th><th>English</th></tr></thead><tbody id="exbody"></tbody></table></div></div>
  </div>
  <footer>© Funwa Slim V3 — Lexicon CSV UTF‑8 · zh‑HK voice supported</footer>
</div>
<script>
function stripBOM(s){return s.replace(/^\uFEFF/,'');}
function parseCSV(text){
  text = stripBOM(text);
  const lines = text.split(/\r?\n/).filter(Boolean);
  const headers = lines[0].split(',').map(x=>x.trim());
  return lines.slice(1).map(line=>{
    const cells = line.split(',');
    const o={};headers.forEach((h,i)=>o[h]=cells[i]?cells[i].trim():'');
    return o;
  });
}
async function loadCSV(path){const r=await fetch(path+'?v='+Date.now());return parseCSV(await r.text());}
const S={lex:new Map(),ex:new Map(),idx:new Map()};
function split(s){return (s||'').split('/').map(x=>x.trim()).filter(Boolean);}
function putIdx(k,v){k=k.toLowerCase();if(!S.idx.has(k))S.idx.set(k,[]);S.idx.get(k).push(v);}
async function boot(){
  const [lex,ex,map]=await Promise.all([loadCSV('data/lexeme.csv'),loadCSV('data/examples.csv'),loadCSV('data/crossmap.csv')]);
  lex.forEach(r=>S.lex.set(r.id,r));
  ex.forEach(r=>{if(!S.ex.has(r.lexeme_id))S.ex.set(r.lexeme_id,[]);S.ex.get(r.lexeme_id).push(r);});
  map.forEach(r=>putIdx(r.term,{id:r.target_id}));
  wire();
}
function wire(){
  const q=document.getElementById('q');
  q.addEventListener('input',()=>{
    const val=q.value.trim().toLowerCase();
    if(!val){document.getElementById('result').style.display='none';return;}
    const keys=[...S.idx.keys()].filter(k=>k.includes(val)).slice(0,5);
    const sug=document.getElementById('suggest');sug.innerHTML=keys.length?("Suggestions: "+keys.join(' / ')):"";
    if(keys.length){render(S.idx.get(keys[0])[0].id);}
  });
}
function render(id){
  const r=S.lex.get(id);if(!r)return;
  document.getElementById('result').style.display='block';
  const z=document.getElementById('zhh');z.innerHTML='';split(r.zhh).forEach(s=>{
    const el=document.createElement('div');el.className='pill';el.textContent=s;
    const btn=document.createElement('span');btn.className='play';btn.textContent='▶';
    btn.onclick=()=>speakHK(s);el.appendChild(btn);z.appendChild(el);
  });
  const e=document.getElementById('en');e.innerHTML=split(r.en).map(x=>'<span class="pill">'+x+'</span>').join('');
  const n=document.getElementById('notes');n.innerHTML=(r.note_en||'')+'<br>'+(r.note_chs||'');
  const exb=document.getElementById('exbody');exb.innerHTML='';
  (S.ex.get(id)||[]).forEach(ex=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${ex.ex_zhh}</td><td>${ex.ex_en}</td>`;exb.appendChild(tr);});
}
function speakHK(t){try{const u=new SpeechSynthesisUtterance(t);u.lang='zh-HK';speechSynthesis.cancel();speechSynthesis.speak(u);}catch{}}
boot();
</script>
</body>
</html>
