<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Canâ€‘Tong Â· ç²¤è¯­åŠ©æ‰‹ï¼ˆKV + è¯­ä¹‰å¬å›ï¼‰</title>
  <style>
    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif;background:#0b0b0c;color:#e8e8ea}
    .wrap{max-width:1060px;margin:40px auto;padding:24px}
    .card{background:#141416;border:1px solid #22232a;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    select,textarea,button,input{background:#0f1013;color:#e8e8ea;border:1px solid #2a2b31;border-radius:10px;padding:10px 12px}
    textarea{width:100%;min-height:120px;resize:vertical}
    button{cursor:pointer}
    .muted{color:#a7a8ad;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
    .out{white-space:pre-wrap;background:#0f1013;border:1px solid #2a2b31;border-radius:10px;padding:12px;min-height:120px}
    .badge{font-size:11px;background:#1b1c22;border:1px solid #2a2b31;border-radius:999px;padding:2px 8px;margin-left:8px}
    .hr{height:1px;background:#2a2b31;margin:16px 0}
    label{display:flex;flex-direction:column;gap:6px}
    input[type="password"]{letter-spacing:2px}
    .col{display:flex;flex-direction:column;gap:8px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Canâ€‘Tong Â· ä¸­è‹±ç²¤äº’è¯‘ + å‘éŸ³ <span class="badge">KV + è¯­ä¹‰å¬å›</span></h1>
      <div class="row">
        <label>æºè¯­è¨€
          <select id="src">
            <option value="en">English</option>
            <option value="chs">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
            <option value="zhh" selected>ç²¤è¯­ï¼ˆæ­£å­—ï¼‰</option>
          </select>
        </label>
        <label>ç›®æ ‡è¯­è¨€
          <select id="tgt">
            <option value="zhh" selected>ç²¤è¯­ï¼ˆæ­£å­—ï¼‰</option>
            <option value="chs">ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</option>
            <option value="en">English</option>
          </select>
        </label>
        <button id="swap">â‡„ äº’æ¢</button>
      </div>
      <textarea id="inp" placeholder="è¾“å…¥è¦ç¿»è¯‘çš„å†…å®¹â€¦ï¼ˆæ”¯æŒ EN / ä¸­æ–‡ / ç²¤è¯­æ­£å­—ï¼‰"></textarea>
      <div class="row">
        <button id="go">ç¿»è¯‘</button>
        <button id="speak">ğŸ”Š ç²¤è¯­å‘éŸ³</button>
        <button id="sem">è¯­ä¹‰ç›¸ä¼¼æŸ¥è¯¢</button>
      </div>
      <div class="grid">
        <div class="col">
          <div class="muted">ç»“æœ</div>
          <div id="out" class="out"></div>
          <div class="muted">ç›¸ä¼¼è¡¨è¾¾ï¼ˆè¯­ä¹‰å¬å› Top 8ï¼‰</div>
          <div id="sim" class="out"></div>
        </div>
        <div class="col">
          <div class="muted">è°ƒè¯• / å¥åº·æ£€æŸ¥</div>
          <div id="ping" class="out">æ£€æŸ¥ä¸­â€¦</div>
          <div class="muted">åŸå§‹å“åº”ï¼ˆmonoï¼‰</div>
          <div id="raw" class="out mono"></div>
        </div>
      </div>

      <div class="hr"></div>
      <h2 style="font-size:18px;margin:4px 0 8px">ç®¡ç†å‘˜ Â· è¯åº“å­¦ä¹ ï¼ˆå†™å…¥ KV + ç”Ÿæˆå‘é‡ï¼Œéœ€è¦å¯†é’¥ï¼‰</h2>
      <div class="row">
        <label>ç®¡ç†å¯†é’¥
          <input id="key" type="password" placeholder="x-api-keyï¼ˆä»…ä½ è‡ªå·±ä½¿ç”¨ï¼‰"/>
        </label>
        <button id="saveKey">ä¿å­˜åˆ°æœ¬æœº</button>
      </div>
      <div class="row">
        <label>ç²¤è¯­ï¼ˆzhhï¼‰<input id="lz" placeholder="ä¾‹å¦‚ï¼šå””å¥½ ong"/></label>
        <label>ä¸­æ–‡ï¼ˆchsï¼‰<input id="lc" placeholder="ä¾‹å¦‚ï¼šåˆ«æ¨ / ä¸è¦æ¨"/></label>
        <label>è‹±æ–‡ï¼ˆenï¼‰<input id="le" placeholder="ä¾‹å¦‚ï¼šdon't push"/></label>
      </div>
      <div class="row">
        <button id="learnOne">å­¦ä¹ ï¼ˆå•æ¡ï¼‰</button>
      </div>
      <label>æ‰¹é‡å­¦ä¹ ï¼ˆJSON æ•°ç»„ï¼Œå…ƒç´ å« zhh/chs/enï¼‰</label>
      <textarea id="bulk" placeholder='[{"zhh":"å’ª ong","chs":"åˆ«æ¨","en":"don\'t push"},{"zhh":"å””å¥½ ong","chs":"ä¸è¦æ¨","en":"do not push"}]'></textarea>
      <div class="row">
        <button id="learnBulk">æ‰¹é‡å­¦ä¹ </button>
      </div>
      <p class="muted">æœ¬é¡µæ¼”ç¤ºï¼šå­¦ä¹ ä¼šåœ¨ KV ä¸­å»ºæ¡ç›® + è®¡ç®—ä¸‰è¯­å‘é‡ï¼›æœç´¢ä¸ç¿»è¯‘æ—¶ä½¿ç”¨â€œè¯­ä¹‰ç›¸ä¼¼å¬å›â€ã€‚</p>
    </div>
  </div>
  <script>
    const $ = (s)=>document.querySelector(s);
    const src = $("#src"), tgt=$("#tgt"), inp=$("#inp"), out=$("#out"), pingBox=$("#ping"), raw=$("#raw"), sim=$("#sim");
    const keyInput = $("#key");
    keyInput.value = localStorage.getItem("ct_key") || "";
    $("#saveKey").onclick = ()=>{ localStorage.setItem("ct_key", keyInput.value||""); alert("å·²ä¿å­˜åˆ°æœ¬æœº"); };

    $("#swap").onclick=()=>{ const a=src.value; src.value=tgt.value; tgt.value=a; };
    async function ping(){
      try{
        const r = await fetch("/api/ping");
        const j = await r.json();
        pingBox.textContent = JSON.stringify(j, null, 2);
      }catch(e){
        pingBox.textContent = "Ping å¤±è´¥ï¼š" + e.message;
      }
    }
    async function translate(){
      out.textContent = "ç¿»è¯‘ä¸­â€¦"; sim.textContent = "";
      try{
        const r = await fetch("/api/translate",{
          method:"POST",
          headers:{"content-type":"application/json"},
          body: JSON.stringify({ text: inp.value, src: src.value, tgt: tgt.value, withSimilar:true })
        });
        const j = await r.json();
        out.textContent = j.text || "";
        raw.textContent = JSON.stringify(j, null, 2);
        if(j.similar && j.similar.length){
          sim.textContent = j.similar.map(x => `â€¢ [${x.lang}] ${x.text}  â†’  zhh:${x.item?.zhh || ""} | chs:${x.item?.chs || ""} | en:${x.item?.en || ""}  (score ${x.score?.toFixed(3)})`).join("\n");
        }
      }catch(e){
        out.textContent = "å‡ºé”™ï¼š" + e.message;
      }
    }
    async function sem(){
      sim.textContent = "æŸ¥è¯¢ä¸­â€¦";
      try{
        const r = await fetch("/api/search?text="+encodeURIComponent(inp.value)+"&topk=8");
        const j = await r.json();
        raw.textContent = JSON.stringify(j, null, 2);
        sim.textContent = j.hits.map(x => `â€¢ [${x.lang}] ${x.text}  â†’  zhh:${x.item?.zhh || ""} | chs:${x.item?.chs || ""} | en:${x.item?.en || ""}  (score ${x.score?.toFixed(3)})`).join("\n");
      }catch(e){
        sim.textContent = "å‡ºé”™ï¼š" + e.message;
      }
    }
    async function speak(){
      const text = (out.textContent || inp.value || "").trim();
      if(!text){ alert("æ²¡æœ‰å¯è¯»çš„æ–‡æœ¬"); return; }
      try{
        const r = await fetch("/api/tts?text="+encodeURIComponent(text));
        if(r.ok && r.headers.get("content-type")?.includes("audio")){
          const blob = await r.blob();
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();
          return;
        }
      }catch(e){}
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "zh-HK";
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }
    async function learnOne(){
      const payload = { zhh: $("#lz").value.trim(), chs: $("#lc").value.trim(), en: $("#le").value.trim() };
      const r = await fetch("/api/learn_semantic", {
        method:"POST",
        headers:{ "content-type":"application/json", "x-api-key": localStorage.getItem("ct_key") || "" },
        body: JSON.stringify({ entries: [payload] })
      });
      const j = await r.json();
      alert("å·²å†™å…¥ï¼ˆå«å‘é‡ï¼‰ï¼š" + JSON.stringify(j));
    }
    async function learnBulk(){
      let arr = [];
      try{ arr = JSON.parse($("#bulk").value || "[]"); }catch(e){ alert("JSON æ— æ³•è§£æ"); return; }
      const r = await fetch("/api/learn_semantic", {
        method:"POST",
        headers:{ "content-type":"application/json", "x-api-key": localStorage.getItem("ct_key") || "" },
        body: JSON.stringify({ entries: arr })
      });
      const j = await r.json();
      alert("æ‰¹é‡ç»“æœï¼ˆå«å‘é‡ï¼‰ï¼š" + JSON.stringify(j));
    }
    $("#go").onclick = translate;
    $("#speak").onclick = speak;
    $("#learnOne").onclick = learnOne;
    $("#learnBulk").onclick = learnBulk;
    $("#sem").onclick = sem;
    ping();
  </script>
</body>
</html>
