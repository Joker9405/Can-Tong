<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Funwa</title>
  <style>
    :root{
      --bg:#03060a;
      --pink:#ff0684;
      --lime:#a5ff00;
      --en:#fafcff;
      --input:#10141c;
      --muted:#8e9aac;
    }
    html,body{margin:0;background:var(--bg);color:#ffffff;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue","PingFang SC","Noto Sans SC","Hiragino Sans GB",sans-serif;}
    .wrap{max-width:980px;margin:48px auto;padding:0 16px}
    .searchBox{display:flex;gap:10px;align-items:center;position:relative}
    .search{flex:1;background:var(--input);color:#fff;border:0;border-radius:16px;padding:16px 18px;font-size:18px;outline:none}
    .btn{background:#223048;color:#fff;border:0;border-radius:14px;padding:12px 16px;cursor:pointer}
    .suggest{position:absolute;left:0;right:120px;top:54px;background:#0b121b;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:8px 6px;display:none;z-index:10}
    .sg{display:inline-block;color:#c9e0ff;background:rgba(255,255,255,.04);padding:8px 12px;border-radius:999px;margin:6px;cursor:pointer}
    .sg:hover{background:rgba(255,255,255,.08)}
    .section{margin-top:18px;display:none;animation:fade .18s ease-out}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .cap{font-size:12px;letter-spacing:.12em;color:#a2acc0;margin-bottom:8px}
    .blk{border:none;border-radius:16px;padding:14px 16px}
    .blk.pink{background:rgba(255,6,132,.18)}
    .blk.lime{background:rgba(165,255,0,.16);color:#eaffb7}
    .blk.gray{background:#0b1119;color:#dbe3f5}
    .pill{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;background:rgba(255,255,255,.06);margin:6px 8px 0 0}
    .pill.pink{background:rgba(255,6,132,.25);color:#fff}
    .pill.gray{background:#101521;color:var(--en)}
    .play{cursor:pointer;font-size:12px;opacity:.9}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;font-size:15px;color:#e8f1ff}
    thead th{opacity:.72;text-transform:uppercase;letter-spacing:.08em}
    tr+tr td{border-top:1px dashed rgba(255,255,255,.14)}
    .hint{margin-top:10px;color:#a2acc0;font-size:12px;opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="searchBox">
      <input id="q" class="search" placeholder="Type Chinese / English / Cantonese…" autocomplete="off"/>
      <button id="speak" class="btn">Speak</button>
      <div id="suggest" class="suggest"></div>
    </div>

    <div id="sec-zhh" class="section">
      <div class="cap">CANTONESE · zhh</div>
      <div id="zhh" class="blk pink"></div>
    </div>

    <div id="sec-alia" class="section">
      <div class="cap">ALIASES · zhh</div>
      <div id="zhh_alias" class="blk pink"></div>
    </div>

    <div id="sec-en" class="section">
      <div class="cap">ENGLISH · en</div>
      <div id="en" class="blk gray"></div>
    </div>

    <div id="sec-notes" class="section">
      <div class="cap">NOTES</div>
      <div id="notes" class="blk lime"></div>
    </div>

    <div id="sec-ex" class="section">
      <div class="cap">EXAMPLES</div>
      <div class="blk pink">
        <table>
          <thead><tr><th style="width:40%">Cantonese</th><th style="width:30%">Chinese</th><th>English</th></tr></thead>
          <tbody id="exbody"></tbody>
        </table>
      </div>
    </div>

    <div class="hint">Data: data/lexeme.csv · data/examples.csv · data/crossmap.csv · UTF‑8/UTF‑8‑SIG.</div>
  </div>

  <script>
  function stripBOM(s){ return s.replace(/^\uFEFF/,''); }
  function parseCSV(text){
    text = stripBOM(text);
    const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length);
    const headers = lines[0].split(",").map(x=>stripBOM(x).trim());
    return lines.slice(1).map(line=>{
      // simple CSV (supports quotes)
      const cells=[]; let cur='', i=0, inq=false;
      while(i<line.length){
        const c=line[i];
        if(inq){
          if(c==='"'){ if(line[i+1]==='"'){ cur+='"'; i+=2; continue;} inq=false; i++; continue;}
          cur+=c; i++; continue;
        }else{
          if(c==='"'){ inq=true; i++; continue; }
          if(c===','){ cells.push(cur); cur=''; i++; continue; }
          cur+=c; i++; continue;
        }
      }
      cells.push(cur);
      const o={}; headers.forEach((h,idx)=> o[h]= stripBOM((cells[idx]||'').trim())); return o;
    });
  }
  async function loadCSV(path){
    const res = await fetch(path+'?v='+Date.now(), {cache:'no-store'});
    if(!res.ok) throw new Error('Load fail '+path);
    return parseCSV(await res.text());
  }
  const S = {lex:new Map(), ex:new Map(), idx:new Map()};
  const split = s => (s||'').split('/').map(x=>x.trim()).filter(Boolean);
  const putIdx=(k,v)=>{k=(k||'').toLowerCase(); if(!k)return; if(!S.idx.has(k))S.idx.set(k,[]); S.idx.get(k).push(v);};
  function speakHK(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='zh-HK'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }

  async function boot(){
    const [lex, ex] = await Promise.all([ loadCSV('data/lexeme.csv'), loadCSV('data/examples.csv') ]);
    lex.forEach(r=>{ if(r.id) S.lex.set(r.id,r); });
    ex.forEach(r=>{ if(r.lexeme_id){ if(!S.ex.has(r.lexeme_id)) S.ex.set(r.lexeme_id,[]); S.ex.get(r.lexeme_id).push(r);} });
    let mp=[]; try{ mp = await loadCSV('data/crossmap.csv'); }catch{}
    if(mp.length){ mp.forEach(r=> putIdx(r.term, {id:r.target_id, kind:r.kind||'head', lang:r.lang||''})); }
    else{
      for(const [id,r] of S.lex.entries()){
        [...split(r.zhh), ...split(r.alias_zhh), ...split(r.en)].forEach(t=> putIdx(t, {id,kind:'head'}));
        (r.note_en||'').split(/[,;，；、\s]+/).forEach(t=> putIdx(t,{id,kind:'note'}));
        (r.note_chs||'').split(/[,;，；、\s]+/).forEach(t=> putIdx(t,{id,kind:'note'}));
      }
    }
    wire();
  }

  function wire(){
    const q=document.getElementById('q'); const speak=document.getElementById('speak');
    q.addEventListener('input', ()=> { suggest(q.value); liveTry(q.value); });
    q.addEventListener('keydown', e=>{ if(e.key==='Enter'){ pickFirst(q.value); } });
    speak.addEventListener('click', ()=> speakHK(q.value||'揼嘢'));
  }

  function showSections(on){
    ['sec-zhh','sec-alia','sec-en','sec-notes','sec-ex'].forEach(id=>{
      document.getElementById(id).style.display = on? 'block':'none';
    });
  }

  function suggest(text){
    const box=document.getElementById('suggest'); box.innerHTML='';
    const q=(text||'').trim().toLowerCase();
    if(!q){ box.style.display='none'; showSections(false); return; }
    const all=[...S.idx.keys()]; const hit=all.filter(k=>k.startsWith(q)).slice(0,8);
    if(!hit.length){ box.style.display='none'; return; }
    hit.forEach(k=>{ const a=document.createElement('span'); a.className='sg'; a.textContent=k; a.onclick=()=>{ document.getElementById('q').value=k; renderPick(k); box.style.display='none'; }; box.appendChild(a); });
    box.style.display='block';
  }

  function pickFirst(text){
    const q=(text||'').trim().toLowerCase(); if(!q) return;
    let cand=S.idx.get(q);
    if(!cand){ const key=[...S.idx.keys()].find(k=>k.startsWith(q)); if(key) cand=S.idx.get(key); }
    if(!cand) return;
    render(cand[0].id);
  }
  function renderPick(term){
    const cand=S.idx.get((term||'').toLowerCase()); if(!cand) return; render(cand[0].id);
  }

  function render(id){
    const r=S.lex.get(id); if(!r) return;
    showSections(true);
    const z=document.getElementById('zhh'); z.innerHTML='';
    split(r.zhh).forEach((s)=>{
      const el=document.createElement('span'); el.className='pill pink'; el.textContent=s;
      const btn=document.createElement('span'); btn.className='play'; btn.textContent='▶';
      btn.onclick=()=> speakHK(s);
      el.appendChild(btn); z.appendChild(el);
    });
    const za=document.getElementById('zhh_alias'); za.innerHTML='';
    split(r.alias_zhh).forEach(s=>{
      const el=document.createElement('span'); el.className='pill pink'; el.textContent=s;
      const btn=document.createElement('span'); btn.className='play'; btn.textContent='▶';
      btn.onclick=()=> speakHK(s);
      el.appendChild(btn); za.appendChild(el);
    });
    const e=document.getElementById('en'); e.innerHTML='';
    split(r.en).forEach(s=>{ const el=document.createElement('span'); el.className='pill gray'; el.textContent=s; e.appendChild(el); });
    const nt=document.getElementById('notes'); nt.innerHTML='';
    const notes=[r.note_en||'', r.note_chs||''].filter(Boolean).map(x=>`<div style="margin:4px 0">${x}</div>`).join('');
    nt.innerHTML= notes || '<span style="opacity:.6">—</span>';
    const tbody=document.getElementById('exbody'); tbody.innerHTML='';
    (S.ex.get(id)||[]).forEach(ex=>{
      const tr=document.createElement('tr');
      const td0=document.createElement('td'); td0.innerHTML=`<span class="pill pink">${ex.ex_zhh||''}</span>`;
      const td1=document.createElement('td'); td1.textContent=ex.ex_chs||'';
      const td2=document.createElement('td'); td2.textContent=ex.ex_en||'';
      tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr);
    });
    document.getElementById('suggest').style.display='none';
  }

  function liveTry(text){
    const q=(text||'').trim().toLowerCase();
    if(!q) return;
    if(S.idx.has(q)){ render(S.idx.get(q)[0].id); }
  }

  boot();
  </script>
</body>
</html>
