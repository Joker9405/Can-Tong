<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Canâ€‘Tong Â· Admin å­¦ä¹ é¢æ¿</title>
  <style>
    html,body{margin:0;padding:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans',sans-serif;background:#0b0b0c;color:#e8e8ea}
    .wrap{max-width:1100px;margin:40px auto;padding:24px}
    .card{background:#141416;border:1px solid #22232a;border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
    textarea,input,button{background:#0f1013;color:#e8e8ea;border:1px solid #2a2b31;border-radius:10px;padding:10px 12px}
    textarea{width:100%;min-height:140px;resize:vertical}
    .muted{color:#a7a8ad;font-size:12px}
    .hr{height:1px;background:#2a2b31;margin:16px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
    .ok{color:#67e8f9} .warn{color:#fbbf24} .err{color:#fb7185}
    .pill{display:inline-block;border:1px solid #2a2b31;border-radius:999px;padding:3px 10px;margin-right:6px}
    input[type="file"]{padding:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Canâ€‘Tong Â· Admin å­¦ä¹ é¢æ¿</h1>
      <p class="muted">æŠŠç½‘å€ / æ–‡æœ¬ / å­—å¹• ä¸¢è¿›æ¥ â†’ ç”Ÿæˆ entries â†’ ä¸€é”®å†™å…¥ KV + åµŒå…¥ã€‚</p>

      <div class="row">
        <label>Admin Key
          <input id="key" type="password" placeholder="x-api-keyï¼ˆä¸ä½ çš„ ADMIN_API_KEY ä¸€è‡´ï¼‰"/>
        </label>
        <button id="saveKey">ä¿å­˜</button>
        <span id="keyStatus" class="muted"></span>
      </div>

      <div class="grid">
        <div>
          <div class="pill">ğŸ“ å¤šä¸ªç½‘å€ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</div>
          <textarea id="urls" placeholder="https://example.com/...\nhttps://..."></textarea>
          <div class="pill">ğŸ“ åŸå§‹æ–‡æœ¬ï¼ˆå¯ç›´æ¥ç²˜è´´ï¼‰</div>
          <textarea id="texts" placeholder="åœ¨æ­¤ç²˜è´´æ•´æ®µæ–‡æœ¬â€¦â€¦"></textarea>
        </div>
        <div>
          <div class="pill">ğŸï¸ å­—å¹•æ–‡ä»¶ï¼ˆSRTï¼Œå¯å¤šé€‰ï¼‰</div>
          <input id="srt" type="file" accept=".srt" multiple/>
          <div id="srtInfo" class="muted" style="margin-top:8px">æœªé€‰æ‹©æ–‡ä»¶</div>
        </div>
      </div>

      <div class="row">
        <button id="gen">ç”Ÿæˆ entriesï¼ˆè°ƒç”¨ /api/ingestï¼‰</button>
        <span id="genInfo" class="muted"></span>
      </div>

      <div class="hr"></div>
      <div class="pill">ğŸ§± entries é¢„è§ˆ / å¯ç¼–è¾‘ï¼ˆJSON æ•°ç»„ï¼Œå…ƒç´ åŒ…å« zhh/chs/enï¼Œè‡³å°‘ä¸¤é¡¹éç©ºï¼›å¤šå˜ä½“ç”¨â€œ/â€åˆ†éš”ï¼‰</div>
      <textarea id="entries" placeholder='[{"zhh":"å””å¥½ong / å’ªong","chs":"åˆ«æ¨ / ä¸è¦æ¨","en":"don\'t push"}]'></textarea>

      <div class="row">
        <button id="commit">ä¸€é”®å†™å…¥ï¼ˆ/api/ingest_commitï¼‰</button>
        <span id="commitInfo" class="muted"></span>
      </div>

      <div class="hr"></div>
      <div class="muted">
        âœ… å†™å…¥æˆåŠŸåï¼ŒæŸ¥è¯¢æ¥å£ <code>/api/translate</code> ä¼šè¿”å›ï¼š<code>{ best: { zhh, en }, related: [...] }</code>ã€‚<br/>
        âœ… åŒä¹‰/å¤šå˜ä½“ä¼šè‡ªåŠ¨æ‰“ç»„ï¼ˆgroupï¼‰ï¼Œç”¨äºè¯­ä¹‰å¬å›ã€‚<br/>
        âš ï¸ æœ¬é¡µé¢åªåœ¨ä½ çŸ¥é“ <code>ADMIN_API_KEY</code> çš„æƒ…å†µä¸‹æœ‰ç”¨ï¼Œè¯·å‹¿å…¬å¼€å¤–ä¼ ã€‚
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const keyEl = $("#key"), urlsEl=$("#urls"), textsEl=$("#texts"), srtEl=$("#srt");
    const entriesEl=$("#entries"), keyStatus=$("#keyStatus"), genInfo=$("#genInfo"), commitInfo=$("#commitInfo"), srtInfo=$("#srtInfo");

    keyEl.value = localStorage.getItem("ct_key") || "";
    keyStatus.textContent = keyEl.value ? "å·²ä»æµè§ˆå™¨æœ¬åœ°è¯»å–" : "æœªä¿å­˜";

    $("#saveKey").onclick = () => {
      localStorage.setItem("ct_key", keyEl.value || "");
      keyStatus.textContent = "å·²ä¿å­˜åˆ°æœ¬æœº";
      setTimeout(()=> keyStatus.textContent = "", 1500);
    };

    srtEl.addEventListener("change", ()=>{
      if(!srtEl.files?.length){ srtInfo.textContent="æœªé€‰æ‹©æ–‡ä»¶"; return; }
      srtInfo.textContent = Array.from(srtEl.files).map(f=>f.name).join(", ");
    });

    async function readSRTFiles(){
      const texts = [];
      for(const f of (srtEl.files || [])){
        const t = await f.text();
        texts.push(t);
      }
      return texts;
    }

    function splitLines(s){ return (s||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean); }

    $("#gen").onclick = async () => {
      genInfo.textContent = "ç”Ÿæˆä¸­â€¦";
      const urls = splitLines(urlsEl.value);
      const texts = textsEl.value ? [textsEl.value] : [];
      const srt = await readSRTFiles();
      try{
        const r = await fetch("/api/ingest", {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ urls, texts, srt })
        });
        const j = await r.json();
        entriesEl.value = JSON.stringify(j.entries || [], null, 2);
        genInfo.textContent = `ç”Ÿæˆå®Œæˆï¼š${(j.entries||[]).length} æ¡`;
      }catch(e){
        genInfo.textContent = "å¤±è´¥ï¼š" + e.message;
      }
    };

    $("#commit").onclick = async () => {
      commitInfo.textContent = "å†™å…¥ä¸­â€¦";
      let arr = [];
      try{ arr = JSON.parse(entriesEl.value || "[]"); }catch(e){
        commitInfo.textContent = "JSON æ— æ³•è§£æ"; return;
      }
      try{
        const r = await fetch("/api/ingest_commit", {
          method: "POST",
          headers: { "content-type":"application/json", "x-api-key": (localStorage.getItem('ct_key')||'') },
          body: JSON.stringify({ entries: arr })
        });
        const j = await r.json();
        commitInfo.textContent = `ç»“æœï¼šok=${j.ok||0}, fail=${j.fail||0}, wrote=${j.wrote||0}`;
      }catch(e){
        commitInfo.textContent = "å¤±è´¥ï¼š" + e.message;
      }
    };
  </script>
</body>
</html>
